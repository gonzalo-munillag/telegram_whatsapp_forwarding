# Telegram â†” WhatsApp Bridge - Docker Compose Configuration
# This file defines how to run the bridge as a Docker container

version: '3.8'

services:
  # Main bridge service
  telegram-whatsapp-bridge:
    # Use pre-built image from Docker Hub
    # IMPORTANT: Replace YOUR_DOCKERHUB_USERNAME with your actual username
    image: ${YOUR_DOCKERHUB_USERNAME}/tgwabridge:latest
    
    # Uncomment to build locally instead of pulling from Docker Hub:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    # Container name
    container_name: telegram-whatsapp-bridge
    
    # Restart policy: always restart unless manually stopped
    # This ensures the bridge keeps running even after Pi reboots
    restart: unless-stopped
    
    # Environment variables from .env file
    # These contain your API keys and configuration
    env_file:
      - .env
    
    # Volumes: Persist data across container restarts
    # This is CRITICAL - without volumes, sessions are lost on restart!
    volumes:
      # Telegram session file (authentication)
      - ./telegram-session.txt:/app/telegram-session.txt:rw
      
      # WhatsApp session data (authentication)
      - whatsapp-auth:/app/.wwebjs_auth
      - whatsapp-cache:/app/.wwebjs_cache
    
    # Security: Run as non-root user
    # The Dockerfile already sets USER node, but this ensures it
    user: "1000:1000"
    
    # Resource limits (adjust based on your Pi model)
    # These prevent the bridge from consuming too much RAM/CPU
    deploy:
      resources:
        limits:
          memory: 512M  # Max 512MB RAM
          cpus: '0.5'   # Max 50% of one CPU core
        reservations:
          memory: 192M  # Reserve at least 192MB RAM
    
    # Logging configuration
    # Prevents logs from filling up disk space
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # Max 10MB per log file
        max-file: "3"        # Keep 3 log files (30MB total)
    
    # Network mode: bridge (default, allows container to access internet)
    network_mode: bridge

# Named volumes for persistent storage
# These are managed by Docker and survive container recreation
volumes:
  whatsapp-auth:
    driver: local
  whatsapp-cache:
    driver: local

